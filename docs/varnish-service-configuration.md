# VarnishService Configuration

| Field                                                  | Description                                                                                                                                                                                                                                                                                                                                          | Is Required |
|--------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------|
| `vclConfigMap`                                         | An object that defines the [VCL ConfigMap configuration](vcl-configuration.md)                                                                                                                                                                                                                                                                       | `required`  |
| `vclConfigMap.name                    `                | Name of the ConfigMap containing the VCL configuration files                                                                                                                                                                                                                                                                                         | `required`  |
| `vclConfgiMap.entrypointFile          `                | The name of the main VCL file                                                                                                                                                                                                                                                                                                                        | `required`  |
| `statefulSet                          `                | An object that defines the configuration of Varnish instances being deployed                                                                                                                                                                                                                                                                         | `optional`  |
| `statefulSet.container                `                | Parameters of Varnish containers                                                                                                                                                                                                                                                                                                                     | `optional`  |
| `statefulSet.container.image          `                | Path to the Varnish image being used                                                                                                                                                                                                                                                                                                                 | `optional`  |
| `statefulSet.container.imagePullPolicy`                | Image pull policy for the containers. Default: `Always`                                                                                                                                                                                                                                                                                              | `optional`  |
| `statefulSet.container.restartPolicy  `                | Restart policy for the containers. Default: `Always`                                                                                                                                                                                                                                                                                                 | `optional`  |
| `statefulSet.container.imagePullSecret`                | The [kubernetes secret used to pull images](https://kubernetes.io/docs/concepts/configuration/secret/#using-imagepullsecrets) from private container registry                                                                                                                                                                                        | `optional`  |
| `statefulSet.container.varnishArgs    `                | Additional [Varnish daemon arguments](https://varnish-cache.org/docs/trunk/reference/varnishd.html#options)                                                                                                                                                                                                                                          | `optional`  |
| `statefulSet.container.resources      `                | [Resource requests and limits](https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#resource-requests-and-limits-of-pod-and-container) for Varnish containers. The [field specs](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#resourcerequirements-v1-core) are the same as in the Pod spec | `optional`  |
| `statefulSet.updateStrategy           `                | Allows to control the way Varnish pods will be [updated](https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#updating-statefulsets).                                                                                                                                                                                       | `optional`  |
| `statefulSet.updateStrategy.type      `                | Defines the type of the update strategy. Default: `OnDelete`                                                                                                                                                                                                                                                                                         | `optional`  |
| `statefulSet.updateStrategy.rollingUpdate `            | Used to communicate parameters when type is `RollingUpdate`                                                                                                                                                                                                                                                                                          | `optional`  |
| `statefulSet.updateStrategy.rollingUpdate.partition `  | Partition indicates the ordinal at which the StatefulSet should be partitioned. Default: 0                                                                                                                                                                                                                                                           | `optional`  |
| `statefulSet.affinity                 `                | [Affinity](https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity) settings for the pods. [Field specs](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#affinity-v1-core) are the same as in the Pod spec                                                                                | `optional`  |
| `statefulSet.tolerations              `                | Configuration that defines which node [taints](https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/) can the pods tolerate. [Field specs](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#toleration-v1-core) are the same as in the Pod spec                                                                | `optional`  |
| `podDisruptionBudget                  `                | [Pod Disruption Budget](https://kubernetes.io/docs/tasks/run-application/configure-pdb/#specifying-a-poddisruptionbudget) configuration                                                                                                                                                                                                              | `optional`  |
| `podDisruptionBudget.maxUnavailable                  ` | An eviction is allowed if at most `maxUnavailable` pods are unavailable after the eviction, i.e. even in absence of the evicted pod. This is a mutually exclusive setting with `minAvailable`                                                                                                                                                        | `optional`  |
| `podDisruptionBudget.minAvailable                  `   | An eviction is allowed if at least `minAvailable` pods will still be available after the eviction, i.e. even in the absence of the evicted pod                                                                                                                                                                                                       | `optional`  |
| `service                              `                | Varnish service configuration. It has all the fields that a regular Service has plus a few additional described below.                                                                                                                                                                                                                               | `required`  |
| `service.varnishPort                  `                | The same spec as for an ordinary Service port. The `targetPort` points to the port your backend pods are listening on                                                                                                                                                                                                                                | `required`  |
| `service.varnishPort.name                  `           | Name of the port. Default `varnish`                                                                                                                                                                                                                                                                                                                  | `optional`  |
| `service.varnishPort.port                  `           | The port that will be exposed by the service                                                                                                                                                                                                                                                                                                         | `required`  |
| `service.varnishPort.targetPort                  `     | The port of the backends being cached by Varnish                                                                                                                                                                                                                                                                                                     | `optional`  |
| `service.varnishExporterPort          `                | Configuration for the Varnish Prometheus exporter port. The spec is the same as for an ordinary Service port. Default port exposed: 9131                                                                                                                                                                                                             | `optional`  |
| `service.varnishExporterPort.name          `           | Name of the port. Default: `varnishexporter`                                                                                                                                                                                                                                                                                                         | `optional`  |
| `service.varnishExporterPort.port          `           | The port that will expose the Prometheus metrics exporter. Default: `varnishexporter`                                                                                                                                                                                                                                                                | `optional`  |
| `service.prometheusAnnotations        `                | Whether add prometheus scrape configuration annotations or not. Default: `false`                                                                                                                                                                                                                                                                     | `optional`  |
| `logLevel                             `                | The minimum enabled logging level. Allowed values: `debug`, `info`, `warn`, `error`, `dpanic`, `panic`, `fatal`. Default: `info`                                                                                                                                                                                                                     | `optional`  |
| `logFormat                            `                | Format of the logs. Can be `json` and `console`. Default: `json`                                                                                                                                                                                                                                                                                     | `optional`  |

You can also find an example of `VarnishService` with detailed comments [here](https://github.ibm.com/TheWeatherCompany/icm-varnish-k8s-operator/blob/master/config/samples/icm_v1alpha1_varnishservice.yaml). 